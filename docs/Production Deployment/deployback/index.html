<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">Production Backend Deployment | STENCIL</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://github.com/CEGRcode/stencil/docs/Production Deployment/deployback"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Production Backend Deployment | STENCIL"><meta data-react-helmet="true" name="description" content="---"><meta data-react-helmet="true" property="og:description" content="---"><link data-react-helmet="true" rel="icon" href="/stencil/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/CEGRcode/stencil/docs/Production Deployment/deployback"><link data-react-helmet="true" rel="alternate" href="https://github.com/CEGRcode/stencil/docs/Production Deployment/deployback" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/CEGRcode/stencil/docs/Production Deployment/deployback" hreflang="x-default"><link rel="stylesheet" href="/stencil/assets/css/styles.814177fe.css">
<link rel="preload" href="/stencil/assets/js/runtime~main.1f067c13.js" as="script">
<link rel="preload" href="/stencil/assets/js/main.de0bc7d5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/stencil/"><div class="navbar__logo"><img src="/stencil/img/logo.svg" alt="STENCIL" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/stencil/img/logo.svg" alt="STENCIL" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">STENCIL</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/stencil/docs/Getting Started/quick">Docs</a><a href="https://github.com/CEGRcode/stencil" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/stencil/docs/Getting Started/quick">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/stencil/docs/Production Deployment/deploystart">Production Deployment</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/stencil/docs/Production Deployment/deploystart">Deployment preparations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/stencil/docs/Production Deployment/deployback">Backend deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/stencil/docs/Production Deployment/deployfront">Frontend deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/stencil/docs/Production Deployment/ssl">SSL security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/stencil/docs/Production Deployment/docker">Docker</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/stencil/docs/STENCIL Guides/payload">STENCIL Guides</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Production Backend Deployment</h1></header><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-mongodb">Install MongoDB<a class="hash-link" href="#install-mongodb" title="Direct link to heading">â€‹</a></h2><ul><li>The following steps assume you are logged in as root</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo su -</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="add-mongodb-repo-to-yum-repo">Add MongoDB repo to yum repo<a class="hash-link" href="#add-mongodb-repo-to-yum-repo" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cat &gt; /etc/yum.repos.d/mongodb-org-5.0.repo &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[mongodb-org-5.0]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">name=MongoDB Repository</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">baseurl=https://repo.mongodb.org/yum/redhat/\$releasever/mongodb-org/5.0/x86_64/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gpgcheck=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">enabled=1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="install-mongodb-1">Install MongoDB<a class="hash-link" href="#install-mongodb-1" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo yum -y install mongodb-org</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="configure-selinux-policy-to-allow-mongodb-to-check-system-memory">Configure SELinux policy to allow MongoDB to check system memory<a class="hash-link" href="#configure-selinux-policy-to-allow-mongodb-to-check-system-memory" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo yum install checkpolicy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cat &gt; mongodb_cgroup_memory.te &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">module mongodb_cgroup_memory 1.0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">require {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      type cgroup_t;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      type mongod_t;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      class dir search;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      class file { getattr open read };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#============= mongod_t ==============</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">allow mongod_t cgroup_t:dir search;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">allow mongod_t cgroup_t:file { getattr open read };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="install-new-mongodb-policy-exception">Install new mongoDB policy exception<a class="hash-link" href="#install-new-mongodb-policy-exception" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">checkmodule -M -m -o mongodb_cgroup_memory.mod mongodb_cgroup_memory.te</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">semodule_package -o mongodb_cgroup_memory.pp -m mongodb_cgroup_memory.mod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo semodule -i mongodb_cgroup_memory.pp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="configure-selinux-policy-to-allow-mongodb-to-report-on-real-time-system-usage">Configure SELinux policy to allow MongoDB to report on real-time system usage<a class="hash-link" href="#configure-selinux-policy-to-allow-mongodb-to-report-on-real-time-system-usage" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cat &gt; mongodb_proc_net.te &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">module mongodb_proc_net 1.0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">require {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        type sysctl_net_t;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        type mongod_t;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        class dir search;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        class file { getattr open read };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#============= mongod_t ==============</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!!!! This avc is allowed in the current policy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">allow mongod_t sysctl_net_t:dir search;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">allow mongod_t sysctl_net_t:file open;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!!!! This avc is allowed in the current policy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">allow mongod_t sysctl_net_t:file { getattr read };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="install-new-mongodb-policy-exception-1">Install new mongoDB policy exception<a class="hash-link" href="#install-new-mongodb-policy-exception-1" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">checkmodule -M -m -o mongodb_proc_net.mod mongodb_proc_net.te</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">semodule_package -o mongodb_proc_net.pp -m mongodb_proc_net.mod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo semodule -i mongodb_proc_net.pp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="configure-server-to-start-mongodb-on-system-reboot">Configure server to start MongoDB on system reboot<a class="hash-link" href="#configure-server-to-start-mongodb-on-system-reboot" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo systemctl enable mongod</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="start-mongodb-server-now">Start MongoDB server now<a class="hash-link" href="#start-mongodb-server-now" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo systemctl start mongod</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-stencil-backend">Install STENCIL-backend<a class="hash-link" href="#install-stencil-backend" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cd stencil/backend</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">npm install</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuring-backend-env">Configuring backend .env<a class="hash-link" href="#configuring-backend-env" title="Direct link to heading">â€‹</a></h2><ul><li>Create a <code>.env</code> file or edit the existing.</li><li>Add settings to your <code>.env</code> file as described in the table below.</li></ul><p><strong>Config details</strong></p><table><thead><tr><th>Setting</th><th>Description</th></tr></thead><tbody><tr><td><code>DB_HOST</code></td><td>Use <code>localhost</code> to connect to a local installation of mongodb (default), please set it to <code>mongo:27017</code> while creating a docker image.</td></tr><tr><td><code>DB_NAME</code></td><td>Name of the database to store app data.</td></tr><tr><td><code>API_PORT</code></td><td>API port name data.</td></tr><tr><td><code>FRONT_API</code></td><td>root URL of the frontend data.</td></tr><tr><td><code>HTTPS</code></td><td>Boolean determining if STENCIL uses HTTPS data.</td></tr><tr><td><code>HTTPSCERT</code></td><td>Not used if HTTPS == false: Path of https certificate  data.</td></tr><tr><td><code>HTTPSKEY</code></td><td>Not used if HTTPS == false: Path of https key data.</td></tr><tr><td><code>SESSION_ENCRYPTION</code></td><td>String used for encript session variables in cookies.</td></tr><tr><td><code>MASTER_PWD</code></td><td>Master login password data.</td></tr><tr><td><code>SVC_STENCIL_PWD</code></td><td>Password to enable STENCIL POST from token data.</td></tr><tr><td><code>PROXY_SETTING</code></td><td>Proxy address data.</td></tr></tbody></table><blockquote><p>default <code>.env</code> configuration for local development</p></blockquote><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">DB_HOST=&quot;localhost&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DB_NAME=&quot;stencilDB&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">API_PORT=8081</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">FRONT_API=&quot;https://localhost:3000&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTPS=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTPSCERT = &quot;/home/xxx/fullchain.pem&quot;   </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTPSKEY = &quot;/home/xxx/privkey.pem&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SESSION_ENCRYPTION = &quot;xxxxxx&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">MASTER_PWD = &quot;aaaaaa&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SVC_STENCIL_PWD = &quot;bbbbbb&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PROXY_SETTING=&#x27;{&quot;/xxx&quot; : &quot;http://xxx.xxxx.xxxx.xx:xxxx&quot;}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li><p><strong>FRONT_API should be set to the address of the STENCIL homepage, this is critical for authentication re-directs</strong></p></li><li><p>SSO_TOKEN_KEY and SSO_TOKEN_IV are used to encrypting user ID by SSO protected redirecting page, and then decrypted by stencil login page. The key must be 32, IV must be 16 char; You should replace the two strings to your own.</p></li><li><p>An example SSO redirecting page is provided in the repository directory sso_apache_site. The restricted directory should be an SSO protected directory. The redirecting page restricted/index.html should be defined as SSOURL. The cgi-bin/stencil.cgi.py file should be modifiedto match SSO_TOKEN_KEY and SSO_TOKEN_IV and redirect URL.</p></li><li><p>If your frontend app needs to access api call from 3rd party, e.g. Galaxy server, you need to use proxy through backend server. In the frontend app, the URL &quot;<a href="http://xxx.xxxx.xxxx.xx:xxxx/datasets/%7Boptions%7D%22" target="_blank" rel="noopener noreferrer">http://xxx.xxxx.xxxx.xx:xxxx/datasets/{options}&quot;</a> should be replaced with &quot;http://backendserver:xxxx/datasets/{options}&quot;. Most browsers would prohibit cross-domain call for the front end, so that proxy is needed.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="open-firewall">Open Firewall<a class="hash-link" href="#open-firewall" title="Direct link to heading">â€‹</a></h2><p>By default, the backend will not be open to the public. Add an exception to open the port the backed is serving at. This should be the &#x27;API_PORT&#x27; variable declared in the .env file.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Required for public access to the backend</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo firewall-cmd --permanent --add-port=8081/tcp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-nodejs-load-balancer-pm2">Install NodeJS load balancer (PM2)<a class="hash-link" href="#install-nodejs-load-balancer-pm2" title="Direct link to heading">â€‹</a></h2><ul><li>Install <a href="https://www.npmjs.com/package/pm2" target="_blank" rel="noopener noreferrer"><code>pm2</code></a> a production process manager for Node.js applications with a built-in load balancer.</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo npm i -g pm2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="configure-pm2">Configure PM2<a class="hash-link" href="#configure-pm2" title="Direct link to heading">â€‹</a></h3><ul><li>PM2 can be configured to auto-restart upon system reboot and to bring the STENCIL backend back online</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm2 startup</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Example resulting output from CentOS 8 and user wkl29:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Init System found: systemd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] To setup the Startup Script, copy/paste the following command:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sudo env PATH=$PATH:/usr/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u wkl29 --hp /home/wkl29</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Copy/paste the resulting sudo command</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[wkl29@artemis backend]$ sudo env PATH=$PATH:/usr/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u wkl29 --hp /home/wkl29</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[sudo] password for wkl29:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        -------------</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">__/\\\\\\\\\\\\\____/\\\\____________/\\\\____/\\\\\\\\\_____</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> _\/\\\/////////\\\_\/\\\\\\________/\\\\\\__/\\\///////\\\___</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  _\/\\\_______\/\\\_\/\\\//\\\____/\\\//\\\_\///______\//\\\__</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   _\/\\\\\\\\\\\\\/__\/\\\\///\\\/\\\/_\/\\\___________/\\\/___</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    _\/\\\/////////____\/\\\__\///\\\/___\/\\\________/\\\//_____</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     _\/\\\_____________\/\\\____\///_____\/\\\_____/\\\//________</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      _\/\\\_____________\/\\\_____________\/\\\___/\\\/___________</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       _\/\\\_____________\/\\\_____________\/\\\__/\\\\\\\\\\\\\\\_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        _\///______________\///______________\///__\///////////////__</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                          Runtime Edition</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        PM2 is a Production Process Manager for Node.js applications</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                     with a built-in Load Balancer.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Start and Daemonize any application:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                $ pm2 start app.js</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Load Balance 4 instances of api.js:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                $ pm2 start api.js -i 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Monitor in production:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                $ pm2 monitor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Make pm2 auto-boot at server restart:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                $ pm2 startup</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                To go further checkout:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                http://pm2.io/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        -------------</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Init System found: systemd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Platform systemd</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Template</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Description=PM2 process manager</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Documentation=https://pm2.keymetrics.io/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">After=network.target</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Type=forking</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">User=wkl29</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LimitNOFILE=infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LimitNPROC=infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LimitCORE=infinity</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Environment=PATH=/home/wkl29/.local/bin:/home/wkl29/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Environment=PM2_HOME=/home/wkl29/.pm2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PIDFile=/home/wkl29/.pm2/pm2.pid</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Restart=on-failure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecStart=/usr/local/lib/node_modules/pm2/bin/pm2 resurrect</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecReload=/usr/local/lib/node_modules/pm2/bin/pm2 reload all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ExecStop=/usr/local/lib/node_modules/pm2/bin/pm2 kill</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WantedBy=multi-user.target</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Target path</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/etc/systemd/system/pm2-wkl29.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Command list</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[ &#x27;systemctl enable pm2-wkl29&#x27; ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Writing init configuration in /etc/systemd/system/pm2-wkl29.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Making script booting at startup...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] [-] Executing: systemctl enable pm2-wkl29...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Created symlink /etc/systemd/system/multi-user.target.wants/pm2-wkl29.service â†’ /etc/systemd/system/pm2-wkl29.service.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] [v] Command successfully executed.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+---------------------------------------+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Freeze a process list on reboot via:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ pm2 save</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Remove init script via:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ pm2 unstartup systemd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="spin-up-stencil-backend">Spin up STENCIL backend<a class="hash-link" href="#spin-up-stencil-backend" title="Direct link to heading">â€‹</a></h3><ul><li>Once you have configured the backend, below command will create a daemon that keeps the app running &amp; restarts on internal app crashes, <a href="https://pm2.io/doc/en/runtime/overview/?utm_source=pm2&amp;utm_medium=website&amp;utm_campaign=rebranding" target="_blank" rel="noopener noreferrer">read more here</a>.</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cd stencil/backend</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm2 start server.js --name STENCILbackend</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>You need to update the <code>options</code> property in the above code with server specific certificate files, after requesting them from a certificate authority.</li><li>Restart the app to apply changes.</li><li>Read more about using certificates at <a href="https://nodejs.org/api/https.html#https_https_createserver_options_requestlistener" target="_blank" rel="noopener noreferrer">Node HTTPS docs</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="save-pm2-configuration">Save PM2 configuration<a class="hash-link" href="#save-pm2-configuration" title="Direct link to heading">â€‹</a></h3><p>This command lets PM2 know that all currently running apps (i.e., STENCIL) are to be restarted upon system reboot</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm2 save</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Example output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">[wkl29@artemis backend]$ pm2 save</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Saving current process list...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[PM2] Successfully saved in /home/wkl29/.pm2/dump.pm2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="convenient-commands-for-pm2">Convenient commands for PM2<a class="hash-link" href="#convenient-commands-for-pm2" title="Direct link to heading">â€‹</a></h3><h5 class="anchor anchorWithStickyNavbar_mojV" id="restart-pm2-instance">Restart PM2 instance<a class="hash-link" href="#restart-pm2-instance" title="Direct link to heading">â€‹</a></h5><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm2 restart STENCILbackend</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="reload-pm2-instance">Reload PM2 instance<a class="hash-link" href="#reload-pm2-instance" title="Direct link to heading">â€‹</a></h5><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm2 reload STENCILbackend</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="stop-pm2-instance">Stop PM2 instance<a class="hash-link" href="#stop-pm2-instance" title="Direct link to heading">â€‹</a></h5><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm2 stop STENCILbackend</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="delete-pm2-instance">Delete PM2 instance<a class="hash-link" href="#delete-pm2-instance" title="Direct link to heading">â€‹</a></h5><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pm2 delete STENCILbackend</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="learn-more">Learn More<a class="hash-link" href="#learn-more" title="Direct link to heading">â€‹</a></h2><hr><ul><li>PM2 documentation <a href="https://pm2.io/doc/en/runtime/overview/?utm_source=pm2&amp;utm_medium=website&amp;utm_campaign=rebranding" target="_blank" rel="noopener noreferrer">HERE</a>.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/Production Deployment/deployback.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/stencil/docs/Production Deployment/deploystart"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Deployment preparations</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/stencil/docs/Production Deployment/deployfront"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Frontend deployment</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#install-mongodb" class="table-of-contents__link toc-highlight">Install MongoDB</a></li><li><a href="#install-stencil-backend" class="table-of-contents__link toc-highlight">Install STENCIL-backend</a></li><li><a href="#configuring-backend-env" class="table-of-contents__link toc-highlight">Configuring backend .env</a></li><li><a href="#open-firewall" class="table-of-contents__link toc-highlight">Open Firewall</a></li><li><a href="#install-nodejs-load-balancer-pm2" class="table-of-contents__link toc-highlight">Install NodeJS load balancer (PM2)</a><ul><li><a href="#configure-pm2" class="table-of-contents__link toc-highlight">Configure PM2</a></li><li><a href="#spin-up-stencil-backend" class="table-of-contents__link toc-highlight">Spin up STENCIL backend</a></li><li><a href="#save-pm2-configuration" class="table-of-contents__link toc-highlight">Save PM2 configuration</a></li><li><a href="#convenient-commands-for-pm2" class="table-of-contents__link toc-highlight">Convenient commands for PM2</a></li></ul></li><li><a href="#learn-more" class="table-of-contents__link toc-highlight">Learn More</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/stencil/assets/js/runtime~main.1f067c13.js"></script>
<script src="/stencil/assets/js/main.de0bc7d5.js"></script>
</body>
</html>